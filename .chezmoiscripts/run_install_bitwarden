#!/bin/bash
#
# Install or update Bitwarden CLI (bw)
#
# Dietrich Liko <Dietrich.Liko@oeaw.ac.at>

set -euo pipefail

BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR"

# --- Version comparison helper ---
verlte() { printf '%s\n' "$1" "$2" | sort -C -V; }

# --- Detect platform ---
OS="$(uname -s)"
case "$OS" in
  Linux*)  PLATFORM="linux" ;;
  Darwin*) PLATFORM="macos" ;;
  *) echo "‚ùå Unsupported OS: $OS"; exit 1 ;;
esac

# --- Get latest CLI release tag ---
TAG=$(curl -s https://api.github.com/repos/bitwarden/clients/releases \
  | jq -r '.[] | select(.tag_name | startswith("cli-")) | .tag_name' \
  | sort -Vr | head -n1)

if [[ -z "$TAG" ]]; then
  echo "‚ùå Could not find a Bitwarden CLI release"
  exit 1
fi

VERSION="${TAG#cli-v}"

# --- Find matching asset ---
MATCH="bw-${PLATFORM}-[0-9.]+\.zip"
URL=$(curl -s "https://api.github.com/repos/bitwarden/clients/releases/tags/$TAG" \
  | jq -r --arg match "$MATCH" '.assets[] | select(.name | test($match)) | .browser_download_url')

if [[ -z "$URL" ]]; then
  echo "‚ùå Could not find a matching asset for $PLATFORM"
  exit 1
fi

NAME="${URL##*/}"
# --- Extract version cleanly from filename (strip trailing dot if any) ---
LATEST_VERSION=$(echo "$NAME" | grep -oE '[0-9]+(\.[0-9]+)*' | head -n1)

# --- Check if bw is already installed ---
if command -v bw >/dev/null 2>&1; then
  INSTALLED_PATH="$(command -v bw)"
  INSTALLED_VERSION="$(bw --version 2>/dev/null | tr -d '\r\n')"

  # Normalize versions (remove any trailing dots)
  LATEST_VERSION="${LATEST_VERSION%.}"
  INSTALLED_VERSION="${INSTALLED_VERSION%.}"

  # If installed outside ~/.local/bin ‚Üí just check version
  if [[ "$INSTALLED_PATH" != "$BIN_DIR/bw" ]]; then
    echo "‚ö†Ô∏è  Detected Bitwarden CLI installed outside ~/.local/bin"
    echo "    Path: $INSTALLED_PATH"
    echo "    Version: $INSTALLED_VERSION"
    if verlte "$LATEST_VERSION" "$INSTALLED_VERSION"; then
      echo "‚úÖ System Bitwarden CLI is up to date ($INSTALLED_VERSION)"
    else
      echo "‚ö†Ô∏è  A newer version is available: $INSTALLED_VERSION ‚Üí $LATEST_VERSION"
    fi
    exit 0
  fi

  # Otherwise, check local version and update if needed
  if [[ "$LATEST_VERSION" == "$INSTALLED_VERSION" ]]; then
    echo "‚úÖ Bitwarden CLI is up to date ($INSTALLED_VERSION)"
    exit 0
  elif verlte "$LATEST_VERSION" "$INSTALLED_VERSION"; then
    echo "‚úÖ Bitwarden CLI is up to date ($INSTALLED_VERSION)"
    exit 0
  else
    echo "‚¨ÜÔ∏è  Updating Bitwarden CLI: $INSTALLED_VERSION ‚Üí $LATEST_VERSION"
  fi
else
  echo "‚¨áÔ∏è  Installing Bitwarden CLI $LATEST_VERSION..."
fi

# --- Download and install ---
TMP_DIR=$(mktemp -d)
(
  cd "$TMP_DIR"
  echo "üì¶ Downloading $NAME..."
  curl -sL "$URL" -o "$NAME"
  unzip -q "$NAME"

  # move binary to ~/.local/bin
  install -m 755 bw "$BIN_DIR/bw"
)
rm -rf "$TMP_DIR"

echo "‚úÖ Installed Bitwarden CLI $LATEST_VERSION to $BIN_DIR/bw"
echo "üîç Version: $($BIN_DIR/bw --version)"

