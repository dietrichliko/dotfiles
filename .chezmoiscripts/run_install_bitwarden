#!/bin/bash
#
# Install or update Bitwarden CLI (bw)
#
# Dietrich Liko <Dietrich.Liko@oeaw.ac.at>

set -euo pipefail

BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR"

# --- Version comparison helper ---
verlte() { printf '%s\n' "$1" "$2" | sort -C -V; }

# --- Detect platform ---
OS="$(uname -s)"
case "$OS" in
  Linux*)  PLATFORM="linux" ;;
  Darwin*) PLATFORM="macos" ;;
  *) echo "‚ùó Unsupported OS: $OS" >&2; exit 1 ;;
esac

# --- Get latest CLI release tag ---
TAG=$(curl -s https://api.github.com/repos/bitwarden/clients/releases \
  | jq -r '.[] | select(.tag_name | startswith("cli-")) | .tag_name' \
  | sort -Vr | head -n1)

if [[ -z "$TAG" ]]; then
  echo "‚ùó Could not find a Bitwarden CLI release" >&2
  exit 1
fi

VERSION="${TAG#cli-v}"

# --- Find matching asset ---
MATCH="bw-${PLATFORM}-[0-9.]+\.zip"
URL=$(curl -s "https://api.github.com/repos/bitwarden/clients/releases/tags/$TAG" \
  | jq -r --arg match "$MATCH" '.assets[] | select(.name | test($match)) | .browser_download_url')

if [[ -z "$URL" ]]; then
  echo "‚ùó Could not find a matching asset for $PLATFORM" >&2
  exit 1
fi

NAME="${URL##*/}"
# --- Extract version cleanly from filename (strip trailing dot if any) ---
LATEST_VERSION=$(echo "$NAME" | grep -oE '[0-9]+(\.[0-9]+)*' | head -n1)

# --- Check if bw is already installed ---
if command -v bw >/dev/null 2>&1; then
  INSTALLED_PATH="$(command -v bw)"
  INSTALLED_VERSION="$(bw --version 2>/dev/null | tr -d '\r\n')"

  # --- Detect EL7 (RHEL/CentOS/Oracle/AMZN Linux 7) ---
  IS_EL7=0
  if [[ -r /etc/redhat-release ]]; then
    if grep -qE 'release[[:space:]]+7' /etc/redhat-release; then
      IS_EL7=1
    fi
  fi

  # Normalize versions (remove any trailing dots)
  LATEST_VERSION="${LATEST_VERSION%.}"
  INSTALLED_VERSION="${INSTALLED_VERSION%.}"

  # If installed outside ~/.local/bin ‚Üí just check version
  if [[ "$INSTALLED_PATH" != "$BIN_DIR/bw" -or "$IS_EL7" -eq 1 ]]; then
    echo "‚úÖ Found bw at $INSTALLED_PATH (version $INSTALLED_VERSION). Managed elsewhere ‚Äî doing nothing."
    if verlte "$LATEST_VERSION" "$INSTALLED_VERSION"; then
      echo "‚úÖ System Bitwarden CLI is up to date ($INSTALLED_VERSION)"
    else
      echo "‚ùó Warning: system Bitwarden CLI ($INSTALLED_VERSION) is older than latest ($LATEST_VERSION)." >&2
    fi
    exit 0
  fi

  # Otherwise, check local version and update if needed
  if [[ "$LATEST_VERSION" == "$INSTALLED_VERSION" ]]; then
    echo "‚úÖ Bitwarden CLI $INSTALLED_VERSION is already up-to-date."
    exit 0
  elif verlte "$LATEST_VERSION" "$INSTALLED_VERSION"; then
    echo "‚úÖ Bitwarden CLI $INSTALLED_VERSION is already up-to-date."
    exit 0
  else
    echo "‚¨ÜÔ∏è Updating Bitwarden CLI from $INSTALLED_VERSION to $LATEST_VERSION..."
  fi
else
  echo "‚¨áÔ∏è Installing Bitwarden CLI $LATEST_VERSION..."
fi

# --- Download and install ---
TMP_DIR=$(mktemp -d)
(
  cd "$TMP_DIR"
  echo "üì¶ Downloading $NAME..."
  curl -sL "$URL" -o "$NAME"
  unzip -q "$NAME"

  # move binary to ~/.local/bin
  install -m 755 bw "$BIN_DIR/bw"
)
rm -rf "$TMP_DIR"

echo "‚úÖ Bitwarden CLI $LATEST_VERSION installed to $BIN_DIR/bw"

