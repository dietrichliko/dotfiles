#!/bin/sh

main() {

    [ -z "$BW_SESSION" ] && fatal "No Bitwarden session"

    if [[ ! "$(bw status)" =~ \"status\":\"([^\"]+)\" ]]; then
        fatal "Cannot extract Bitwarden status" 
    fi
    if [ "${BASH_REMATCH[1]}" != "unlocked" ]; then
        fatal "Bitwarden session is locked."
    fi

    # hack
    item_info=$(bw list items --search "CERN DELPHI")
    username=$(echo "$item_info" | jq -r ".[0].login.username")
    [ -z "$username" ] && fatal "Cannot extract username"
    password=$(echo "$item_info" | jq -r ".[0].login.password")
    [ -z "$password" ] && fatal "Cannot extract password"
    echo $password | kinit -fp "${username}@CERN.CH" >/dev/null

}

fatal() {

    echo "FATAL: $@"
    exit 1

}

main "$@"
