#!/bin/sh

main() {

    [ -z "$BW_SESSION" ] && fatal "No Bitwarden session"

    [ -z "$BW_SESSION" ] && fatal "No Bitwarden session"

    if [[ $(bw status| jq -r ".status") != "unlocked" ]]; then
        fatal "Bitwarden session is locked."
    fi

    id="86e7067a-6e82-41b9-a6f8-add4010274f5"
    username="$(bw get username "$id")"
    password="$(bw get password "$id")"

    echo $password | kinit -fp "${username}@CERN.CH" >/dev/null

}

fatal() {

    echo "FATAL: $@"
    exit 1

}

main "$@"
