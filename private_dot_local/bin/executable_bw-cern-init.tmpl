#!/bin/bash

main() {

    [ -z "$BW_SESSION" ] && fatal "No Bitwarden session"

    if [[ $(bw status| jq -r ".status") != "unlocked" ]]; then
        fatal "Bitwarden session is locked."
    fi

    id="614223ea-4ae4-44ec-9f8c-ac5300ea104a"
    username="$(bw get username "$id")"
{{- if eq .chezmoi.os "darwin" }}
    tmpfile=$(mktemp)
    bw get password "$id" >"$tmpfile"
    kinit --password-file="$tmpfile" -fp "${username}@CERN.CH"
    rm "$tmpfile"
{{- else }}
    echo $password | kinit -fp "${username}@CERN.CH" >/dev/null
{{- end }}
}

fatal() {

    echo "FATAL: $@"
    exit 1

}

main "$@"
